<style>
    @media (max-width: 767px) {
        .hgroup .breadcrumb {
            bottom:-15px !important;
        }
    }
    .hgroup.centered h2 {
    margin: 0;
    color: green;
    font-weight: bold;
}
hr {
       border-top: 1px solid #cccccc;
}
.portfolio_strict .portfolio_item .portfolio_description p {
    margin: 0;
    padding: 0;
    font-size: 13px;
    color: black;
    text-transform: uppercase;
    letter-spacing: 1px;
    
    padding-left: 120px !important;
}
.portfolio_item figure figcaption .view_button {
    display:none !important;
}
a:hover {
    color:green;
}
 .portfolio_strict .portfolio_item figure figcaption p {
    padding: 10px 20px;
    color: #aaa;
    font-weight: 300;
    font-size: 13px;
    transform: translateY(-10px);
    -webkit-transform: translateY(-10px);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    timing-function: cubic-bezier(0.25, 0.25, 0.115, 1.445);
    -webkit-animation-timing-function: cubic-bezier(0.25, 0.25, 0.115, 1.445);
    opacity: 0;
    display: none !important;
}
.portfolio_item figure figcaption {
    position: absolute;
    top: 0;
    z-index: 11;
    padding: 0px;
    width: 100%;
    height: 100%;
    text-align: center;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
   
    border: 1px solid #cccccc;
}
@media only screen and (max-width: 767px) 
{
.portfolio_strict .portfolio_item .portfolio_description p {
    padding-left:135px !important;
}
}
</style>
<div id="pop-over">
    <span class="pull-left">
        <p id="pop-over-map-name">Default Name</p>
        <p id="pop-over-map-phone">Phone Number</p>
    </span>
    <span class="pullright">
        <img alt="arrow" src="http://kodekloud.s3.amazonaws.com/sites/54612c496e6f6474ba020000/efe6c3ca0d8b7c35dc70c11b3c667cdf/arrow_green.png">
    </span>
</div>
<div id="back-top"><img alt="BackToTop" src="http://kodekloud.s3.amazonaws.com/sites/54b83f086e6f646b45000000/c0a5afb0d05049981f657ccf2e67d904/totop.jpg"/></div>
<div id="loading_screen">
    <img src="http://kodekloud.s3.amazonaws.com/sites/5447ebb66e6f641987020000/3604f5c26997bea3de504de139debcec/loading.gif"/>
</div>
<div id="main_content" style="display:none">
<div class="full_page_photo" style="overflow:hidden">

        <div style="overflow:hidden">
            <div id="zControls">
                <button class="zoom-in"><span class="glyphicon glyphicon-plus"></span></button>
                <button class="zoom-out"><span class="glyphicon glyphicon-minus"></span></button>
                
            </div>
            <div id="map" class="panzoom-elements"></div>
        </div>
            

</div>
<div class="main">
     <div class="container">
          <section class="hgroup centered store_directory_hgroup">
               <h1>Store Directory</h1>
              <h2>Download Store Directory</h2>
               <ul class="breadcrumb pull-right">
                    <li><a href="/home">Home</a> </li>
                    <li class="active">Store Directory</li>
               </ul>
          </section>
          
          <div class="categories_list" id="categories_container">
                <a href="#categories_container" onclick="show_cat('nil','all')" class="btn btn-primary">View All</a>
          </div>
          
           <div class="portfolio_strict row" id="store_list_container">
                <script id="store_list_template" type="x-tmpl-mustache/text">
                    <div class="col-sm-4 col-md-4">
                         <div class="portfolio_item wow animated flipInX"> <a href="/stores/{{slug}}" data-path-hover="M 180,190 0,158 0,0 180,0 z">
                              <figure style="background-image:url({{alt_store_front_url}})">
                                   <svg viewBox="0 0 180 320" preserveAspectRatio="none">
                                        <path d="M 180,0 0,0 0,0 180,0 z"/>
                                   </svg>
                                   <figcaption>
                                        <p>{{description}}</p>
                                        <div class="view_button">View</div>
                                   </figcaption>
                              </figure>
                              </a>
                              <div class="portfolio_description">
                                   <h3><a href="../stores/{{slug}}">{{name}}</a></h3>
                                   <a href="tel:{{phone}}"><p class="directory_content directory_phone_col"><img src="http://assets.codecloudapp.com/sites/55887c646e6f642257020000/14c4e580b98e351a243ce8245fbcc446/telephone66 2.png">&nbsp;{{phone}}</a></p>
                                  
                              </div>
                               
                         </div>
                         <hr>
                    </div>
                </script>
        </div>
<!--For more information please see http://learnjs.io/blog/2013/11/30/snapsvg-resources/-->
<script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js"></script>
<script src="http://kodekloud.s3.amazonaws.com/sites/5422419e4a616d74d9030000/e1fb5e17ab727d248230fbcb51da868f/jquery.panzoom.min.js"></script>
<script>
    $("#directory_link").addClass("active");
    $(document).ready(function() {
    function renderAll(){
        var stores = getStoresList();
        var category_stores = getStoresListByCategory();
        var categories = getStoreCategories();
        renderPageData('#store_list_container','#store_list_template', stores, "stores");
        // renderPageData('#categories_container', '#categories_list_template', categories, "categories");
        render_categories(categories);
        render_category_stores();    
        $("#loading_screen").hide();
        $("#main_content").show();
        renderSVGMap();
    }
    
    
    
    
    function renderSVGMap(){
        var isMobile = ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
        var didPanZoom = false;
        if(navigator.appVersion.indexOf("MSIE 9.") == -1){
            $('#map').bind('mousemove', function(e){
                //console.log(e.pageX+","+e.pageY);
               $('#pop-over').css({'top':e.pageY+20,'left':e.pageX-70});
            });
            var s = Snap("#map");
            var stores = getStoresList();
            console.log (getSVGMapURL())
            Snap.load(getSVGMapURL(), function (f) {
                $.each( stores, function( key, value ) {
                    if(value.svgmap_region != null && typeof(value.svgmap_region)  != 'undefined'){
                        var svg_id = "#" + value.svgmap_region;
                        f.select(svg_id).mouseover(function() {
                            if(typeof(value) != 'undefined' && value != null){
                                this.addClass("map-mouse-over");
                                $("#pop-over").show();
                                $("#pop-over-map-name").html(value.name);
                                $("#pop-over-map-phone").html(value.phone);
                            }
                                      
                        });
                            
                        //add the mouse up handler for hiding the pop over when done hovering
                        f.select(svg_id).mouseout(function() {
                            this.removeClass("map-mouse-over");
                            $("#pop-over").hide(0);
                            
                        });
                            
                        //add the mouse up function for when the user clicks a store
                        f.select(svg_id).mouseup(function() {
                            
                            if(!isMobile && !didPanZoom){
                                
                                goToStore(value);
                            }
                            didPanZoom = false;
                                  
                        });
                    }
                });
                s.append(f.select("svg"));
            });
            var startingMapTransform = 'scale(0.8)';
            var startingPanX =150;
            var startingPanY = -150;
            if(isMobile) {
                    startingMapTransform = 'scale(0.4)';
                    startingPanX = -140;
                    startingPanY = -140;
            }
                // $('#loading').hide();
                $( "#page_content" ).fadeIn( "fast", function() {
                    var panzoom = $(".panzoom-elements").panzoom({
                        cursor: "move",
                        increment: 0.5,
                        minScale: 0.15,
                        maxScale: 20,
                        transition: true,
                        duration: 150,
                        easing: "ease-in-out",
                        $zoomIn: $('.zoom-in'),
                        $zoomOut: $('.zoom-out'),
                        $zoomRange: $('.zoom-range'),
                        startTransform: startingMapTransform
            
                    });
                    $(".panzoom-elements").panzoom("pan", startingPanX, startingPanY, { relative: true });
                    
                    panzoom.on('panzoomchange', function(e, panzoom, matrix, changed) {
                      didPanZoom = true;
                    });
                    
                    panzoom.on('panzoomend', function(e, panzoom, matrix, changed) {
                      didPanZoom = false;
                    });
                });
            }else{
                $('#loading').hide();
                $('#zControls').hide();
                $('#map').hide();
                $( "#page_content" ).fadeIn( "fast");
            }
        }
    
    function goToStore(store_details){
        if(typeof(store_details) != 'undefined' && store_details != null){
            window.location.href = "/stores/"+store_details.slug;
        }
    }

    function getSVGMapURL(){
        initData();
        var mallDataJSON = JSON.parse(sessionStorage.mallData);
        return 'http://cdn.mallmaverick.com' + mallDataJSON.property.svgmap_url;
    }
    
    
    function render_categories(categories){
        
        $.each( categories , function( key, val ) {
            val.link = "cat" + val.id;
            $("#categories_container").append('<a href="#categories_container" onclick=(show_cat('+val.link+')) class="btn btn-primary">'+val.name+'</a>');
        });
    };
    function renderPageData(container, template, collection, type){
        var item_list = [];
        var item_rendered = [];
        var template_html = $(template).html();
        Mustache.parse(template_html);   // optional, speeds up future uses
        $.each( collection , function( key, val ) {
            if (type == "stores" || type == "category_stores"){
                if(!val.store_front_url ||  val.store_front_url.indexOf('missing.png') > -1 || val.store_front_url.length === 0){
                        val.alt_store_front_url = "http://kodekloud.s3.amazonaws.com/sites/54cfabe36e6f641f2e010000/e3caeac24db5ab4cc9a8679e6db6392d/VV_default.jpg"    
                } else {
                    val.alt_store_front_url = getImageURL(val.store_front_url);    
                }
            }
            
            var rendered = Mustache.render(template_html,val);
            item_rendered.push(rendered);

        });
        
        $(container).show();
        $(container).html(item_rendered.join(''));
    };
    

    function render_category_stores(){
        
        var category_stores = [];
        var item_rendered = [];
        var all_stores = getStoresList();
        var all_categories = getStoreCategories();
        var test = []
        var template_html = $("#category_store_list_template").html();
        Mustache.parse(template_html);
        for (i = 0; i < all_categories.length; i++) {
            var stores_per_cat = [];
            for (j = 0; j < all_stores.length; j++) {
                if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                    all_stores[j].cat_name = all_categories[i].name;
                    category_stores.push(all_stores[j]);
                    stores_per_cat.push(all_stores[j]);
                }
            
            }
            var rendered = Mustache.render(template_html,all_categories[i]);
            item_rendered.push(rendered);
        }
        $("#store_category_list_container").show();
        $("#store_category_list_container").html(item_rendered.join(''));
        for (i = 0; i < all_categories.length; i++) {
            var stores_per_cat = [];
            for (j = 0; j < all_stores.length; j++) {
                if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                    all_stores[j].cat_name = all_categories[i].name;
                    all_stores[j].alt_store_front_url = getImageURL(all_stores[j].store_front_url);    
                    populate_stores_for_cat(all_categories[i].id, all_stores[j]);
                }
            
            }
        }
        
    };
    
    function populate_stores_for_cat (categoryid, store){
        // console.log (categoryid);
        // console.log(store);
        $('#cat'+ categoryid).append('<section class="service_teasers" id="store_for_'+store.id+'"><div class="service_teaser"><div class="row"><div class="service_photo col-sm-4 col-md-4"><a href="../stores/'+store.slug+'"> <figure style="background-image:url('+store.alt_store_front_url+')"></figure></a></div><div class="service_details col-sm-8 col-md-8"><h2 class="section_header skincolored"><b><a href="../stores/'+store.slug+'">'+store.name+'</a></b></h2><p>'+store.description+'</p><span><p class="pull-left"><i class="fa fa-phone"></i><a href="tel:'+store.phone+'">  '+store.phone+'</a></p><a href="../stores/'+store.slug+'" class="btn btn-primary pull-right">view detail</a></div></div></div></div></section>');    }
    
        loadMallData(renderAll);  
    
  
    });
    
    function show_cat(link, type){
   
        if (type == "all"){
            $("#store_list_container").show();
            $(".cat_list_div").hide();    
        } else {
            $("#store_list_container").hide();
            $(".cat_list_div").hide();
            $("#"+link.id).show();    
        }
    
        
    }
    
    
    
    // hide #back-top first
	$("#back-top").hide();
	
	// fade in #back-top
	$(function () {
		$(window).scroll(function () {
		    if ($(this).scrollTop() > 300) {
    			$('#back-top').fadeIn();
			} else {
				$('#back-top').fadeOut();
			}
		});

		// scroll body to 0px on click
		$('#back-top img').click(function () {
			$('body,html').animate({
				scrollTop: 0
			}, 800);
			return false;
		});
	});
</script>